{"version":20,"variables":[{"version":2,"key":"APIGateway","type":"query","visible":true,"editable":true,"input":"smartscapeNodes \"AWS_APIGATEWAY_RESTAPI*\"\n| fieldsAdd instanceId = toString(id)\n| fieldsKeep aws.resource.name\n// | fields instanceId\n// | sort instanceId ","multiple":false,"defaultValue":"o11y-lab-initializer"},{"version":2,"key":"APIGatewayURL","type":"query","visible":false,"editable":true,"input":"data record ()\n| append [ \nsmartscapeNodes \"AWS_APIGATEWAY_RESTAPI*\"\n| fieldsAdd instanceId = toString(id)\n | filter name == $APIGateway\n | fieldsKeep aws.resource.id\n]","multiple":false},{"version":2,"key":"FunctionsIDs","type":"query","visible":false,"editable":true,"input":"fetch spans\n| filter contains(server.address, $APIGatewayURL)\n| filter request.is_root_span == true\n| filter  isNotNull(endpoint.name) and isNotNull(duration)\n| filterOut endpoint.name == \"Images\" or \n            endpoint.name == \"JavaScript\" or\n            endpoint.name == \"CSS\"\n| fields dt.entity.service, endpoint.name, trace.id, duration, faas.name\n| join [fetch spans\n        | filter isNotNull(endpoint.name) or isNotNull(db.query.text) or isNotNull(messaging.operation.type)\n        | filterOut endpoint.name == \"Images\" or \n            endpoint.name == \"JavaScript\" or\n            endpoint.name == \"CSS\"\n        | summarize {\n      child_requests = arrayRemoveNulls(collectDistinct(\n      record(\n        faas.name,\n        dt.entity.service\n        )))}, \n        by: {trace.id}],\n        kind: leftOuter,\n        on: {trace.id},\n        executionOrder:leftFirst\n| expand right.child_requests \n| fieldsFlatten right.child_requests \n| filterOut right.child_requests.faas.name == \"o11y-lab-lambda-payments-psp\"\n| fieldsRemove right.child_requests, trace.id, right.trace.id, faas.name, endpoint.name, duration, right.child_requests.faas.name\n| dedup dt.entity.service, right.child_requests.dt.entity.service\n\n","multiple":true,"defaultValue":["3420b2ac-f1cf-4b24-b62d-61ba1ba8ed05*"]},{"version":2,"key":"TraceId","type":"text","visible":false,"editable":true},{"version":2,"key":"LambdaWalletName","type":"text","visible":false,"editable":true,"defaultValue":"o11y-lab-lambda-payments-wallet"},{"version":2,"key":"LambdaInitializerName","type":"text","visible":false,"editable":true,"defaultValue":"o11y-lab-lambda-payments-initializer"},{"version":2,"key":"LambdaExecutorName","type":"text","visible":false,"editable":true,"defaultValue":"o11y-lab-lambda-payments-executor"},{"version":2,"key":"PaymentEvent","type":"text","visible":false,"editable":true,"defaultValue":"PaymentEvent"},{"version":2,"key":"PaymentOrder","type":"text","visible":false,"editable":true,"defaultValue":"PaymentOrder"},{"version":2,"key":"Wallet","type":"text","visible":false,"editable":true,"defaultValue":"Wallet"},{"version":2,"key":"AccountId","type":"query","visible":false,"editable":true,"input":"smartscapeNodes \"AWS_APIGATEWAY*\"\n| sort aws.account.id asc\n| summarize collectDistinct(aws.account.id)","multiple":true,"defaultValue":["3420b2ac-f1cf-4b24-b62d-61ba1ba8ed05*"]},{"version":2,"key":"Region","type":"query","visible":false,"editable":true,"input":"smartscapeNodes \"AWS_APIGATEWAY*\"\n| sort aws.region asc\n| summarize collectDistinct(aws.region)","multiple":true,"defaultValue":["3420b2ac-f1cf-4b24-b62d-61ba1ba8ed05*"]},{"version":2,"key":"InstanceIdInitilizer","type":"query","visible":false,"editable":true,"input":"// data record (keys=\"ALL\")\n// | append [ \n  smartscapeNodes \"AWS_LAMBDA_FUNCTION*\"\n  | filter contains(name, \"initializer\")\n  | fieldsAdd instanceId = toString(id)\n  | fields instanceId \n  // ]","multiple":false},{"version":2,"key":"InstanceIdExecutor","type":"query","visible":false,"editable":true,"input":"// data record (keys=\"ALL\")\n// | append [ \n  smartscapeNodes \"AWS_LAMBDA_FUNCTION*\"\n  | filter contains(name, \"executor\")\n  | fieldsAdd instanceId = toString(id)\n  | fields instanceId \n  // ]","multiple":false},{"key":"InstanceIdWallet","visible":false,"type":"query","version":2,"editable":true,"input":"// data record (keys=\"ALL\")\n// | append [ \n  smartscapeNodes \"AWS_LAMBDA_FUNCTION*\"\n  | filter contains(name, \"wallet\")\n  | fieldsAdd instanceId = toString(id)\n  | fields instanceId \n  // ]","multiple":false},{"version":2,"key":"ApiGatewayRestInstanceId","type":"query","visible":false,"editable":true,"input":"data record ()\n| append [ \nsmartscapeNodes \"AWS_APIGATEWAY_RESTAPI*\"\n| fieldsAdd instanceId = toString(id)\n| filter name == $APIGateway\n| fields instanceId\n| sort instanceId \n]","multiple":false,"defaultValue":"AWS_APIGATEWAY_RESTAPI-F4EFF76297F5DACB"},{"version":2,"key":"Limit","type":"text","visible":false,"editable":true,"defaultValue":"50"}],"tiles":{"0":{"type":"markdown","content":"# Analyze the End-2-End Serverless Workflow for our Payment App\n---\nAnalyze each step of the AWS Serverless Workflow: Init -> Executor -> Wallet\n\nSee how many individual steps fail, what the success rate is between major steps and click to analyze the failed distributed traces  \n\n![](https://lucid.app/publicSegments/view/e44d72d5-4e4c-4728-b057-193658092fc7/image.jpeg)\n\n---\n"},"1":{"title":"Service Health","type":"data","query":"fetch dt.entity.service\n| filter in(id, $FunctionsIDs)\n| lookup [\n  fetch dt.davis.problems\n  | filter event.status==\"ACTIVE\" and dt.davis.is_duplicate==false\n  | expand affected_entity_ids\n  | fieldsAdd severity=if(\n  event.category==\"AVAILABILITY\", 1, else: if(\n  event.category==\"ERROR\", 3, else: if(\n  event.category==\"SLOWDOWN\", 4, else: if(\n  event.category==\"RESOURCE_CONTENTION\", 5, else: if(\n  event.category==\"CUSTOM_ALERT\", 2)))))\n  | sort severity, display_id\n], sourceField:id, lookupField:affected_entity_ids, fields:{event.status, display_id, event.start, event.id, event.category, severity}\n| fieldsAdd timestamp=$dt_timeframe_to, severity=coalesce(severity, 10), status=if(event.status==\"ACTIVE\", event.category, else: \"OK\")\n| sort severity asc, entity.name","visualization":"honeycomb","visualizationSettings":{"honeycomb":{"colorMode":"custom-colors","customColors":[{"id":78010,"value":"OK","color":{"Default":"var(--dt-colors-charts-categorical-color-03-default, #2a7453)"},"comparator":"="},{"id":103026,"value":"ERROR","color":{"Default":"var(--dt-colors-charts-apdex-unacceptable-default, #cd3741)"},"comparator":"="},{"id":114581,"value":"AVAILABILITY","color":{"Default":"var(--dt-colors-charts-categorical-themed-fireplace-color-06-default, #9033a3)"},"comparator":"="},{"id":119230,"value":"SLOWDOWN","color":{"Default":"var(--dt-colors-charts-apdex-fair-default, #a9780f)"},"comparator":"="},{"id":127876,"value":"RESOURCE_CONTENTION","color":{"Default":"var(--dt-colors-charts-categorical-themed-blue-steel-color-05-default, #134fc9)"},"comparator":"="},{"id":134184,"value":"CUSTOM_ALERT","color":{"Default":"var(--dt-colors-charts-categorical-color-04-default, #d85a9f)"},"comparator":"="}],"dataMappings":{"value":"status"},"displayedFields":["entity.name"],"legend":{"hidden":true}}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"4":{"type":"markdown","content":"Init\n\n|\n\n|\n\n|\n\n|\n\n|\n\n|\n\n|\n\n|"},"5":{"title":"Step 1: Initialize","type":"data","query":"fetch spans\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n| filter faas.name == $LambdaInitializerName and span.name == \"handler\"\n| summarize {\n    Requests = count(),\n    `P50 duration` = percentile(duration, 50),\n    `Avg duration` = avg(duration),\n    `4xx` = countIf(http.response.status_code >= 400 and http.response.status_code < 500),\n    `5xx` = countIf(http.response.status_code >= 500 and http.response.status_code < 600),\n    `Cold starts` = countIf(faas.coldstart)\n}\n| fieldsAdd `Failure Rate` = if(Requests > 0, \n    (toDouble(`4xx`) + toDouble(`5xx`)) / toDouble(Requests) * 100, \n    else: 0)\n// | fieldsAdd failureStatus = if(failureRate > 10, \"Critical\", \n// else: if(failureRate > 5, \"Warning\",\n//     else: \"OK\")) \n\n","visualization":"table","visualizationSettings":{"table":{"colorThresholdTarget":"background","columnOrder":["[\"Requests\"]","[\"P50 duration\"]","[\"Avg duration\"]","[\"4xx\"]","[\"5xx\"]","[\"Failure Rate\"]","[\"Cold starts\"]"],"columnTypeOverrides":[{"id":2929126,"fields":[],"value":"text"}],"hideColumnsForLargeResults":false,"monospacedFontColumns":[["Requests"],["Duration"],["avgDuration"],["4xx"],["5xx"],["failureRate"],["failureStatus"]],"lineWrapIds":[["Requests"],["Duration"],["avgDuration"],["4xx"],["5xx"],["failureRate"],["failureStatus"]],"sortBy":[{"columnId":"[\"P50 duration\"]","direction":"ascending"}],"selectedColumnForRowThreshold":"failureRate","columnWidths":{"[\"Cold starts\"]":83}},"autoSelectVisualization":true,"thresholds":[{"id":1,"field":"failureRate","title":"Failure Rate","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"<","label":"","value":5},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":5},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":10}]}],"unitsOverrides":[{"identifier":"failureRate","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1762372384338}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"6":{"title":"Step 2 - Put in DynamoDB - PaymentEvent & Payment Order","type":"data","query":"fetch spans\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n| filter faas.name == $LambdaInitializerName and span.name == \"PutItem dynamodb\"\n| filter db.collection.name == $PaymentEvent\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n| fields count, failed = toDouble(100*countFailed)/count, avgDur\n| fieldsAdd dbName = $PaymentEvent\n| append [\n  fetch spans\n  | filter faas.name == $LambdaInitializerName and span.name == \"BatchWriteItem dynamodb\"\n  | filter db.collection.name == $PaymentOrder\n  | fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n  | summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n  | fields count, failed = toDouble(100*countFailed)/count, avgDur\n  | fieldsAdd dbName = $PaymentOrder\n]\n| fields DB = dbName,\n`Count` = count, \n`Failed` = failed,\n`Avg duration` = avgDur\n\n","visualization":"table","visualizationSettings":{"autoSelectVisualization":false,"unitsOverrides":[{"identifier":"Failed","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025},{"identifier":"Avg duration","unitCategory":"time","baseUnit":"nanosecond","displayUnit":null,"decimals":0,"suffix":"","delimiter":false,"added":1762413752103}],"thresholds":[{"id":1,"field":"failed","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":0},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":""},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":1}]}],"table":{"colorThresholdTarget":"background","hideColumnsForLargeResults":true,"sortBy":[{"columnId":"[\"DB\"]","direction":"ascending"}],"columnWidths":{"[\"count\"]":70,"[\"failed\"]":61,"[\"Count\"]":72.52}}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"9":{"title":"Step 3 - Send event to SQS ","type":"data","query":"fetch spans\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n| filter faas.name == $LambdaInitializerName and span.name == \"sqs/SendMessage\"\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n| fields \n`Count` = count, \n`Failed` = toDouble(100*countFailed)/count,\n`Avg duration` = avgDur","visualization":"table","visualizationSettings":{"autoSelectVisualization":true,"table":{"colorThresholdTarget":"background","hideColumnsForLargeResults":true,"sortBy":[{"columnId":"[\"count\"]","direction":"ascending"}],"columnWidths":{"[\"count\"]":91}},"unitsOverrides":[{"identifier":"failed","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025},{"identifier":"avgDur","unitCategory":"time","baseUnit":"nanosecond","displayUnit":null,"decimals":0,"suffix":"","delimiter":false,"added":1762413765318}],"thresholds":[{"id":1,"field":"failed","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":0},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":""},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":1}]}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"10":{"type":"markdown","content":"Exec\n\n|\n\n|\n\n|\n\n|\n\n|\n\n|"},"11":{"title":"Step 3: Execution","type":"data","query":"fetch spans\n// | filter subtrace.is_root_span == true\n//     and span.kind == \"consumer\"\n//     and faas.trigger == \"pubsub\"\n//     and messaging.source.name == \"o11y-lab-payment-execution-queue\"\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n| filter faas.name == $LambdaExecutorName and span.name == \"handler\"\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize {\n    Requests = count(),\n    `P50 duration` = percentile(duration, 50),\n    `Avg duration` = avg(duration),\n    Failures = countIf(isFailed),\n    `Cold starts` = countIf(faas.coldstart)\n}\n| fieldsAdd `Failure Rate` = if(Requests > 0, \n    (toDouble(Failures) / toDouble(Requests)) * 100, \n    else: 0)\n// | fieldsAdd failureStatus = if(failureRate > 10, \"Critical\", \n// else: if(failureRate > 5, \"Warning\",\n//     else: \"OK\")) \n\n\n// fetch spans\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n// | filter faas.name == \"o11y-lab-lambda-payments-executor\" and span.name == \"handler\"\n// | fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n// | summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n// | fields count, failed = toDouble(100*countFailed)/count, avgDur\n","visualization":"table","visualizationSettings":{"table":{"colorThresholdTarget":"background","hideColumnsForLargeResults":false,"monospacedFontColumns":[["Requests"],["Duration"],["avgDuration"],["4xx"],["5xx"],["failureRate"],["failureStatus"]],"lineWrapIds":[["Requests"],["Duration"],["avgDuration"],["4xx"],["5xx"],["failureRate"],["failureStatus"]],"sortBy":[{"columnId":"[\"Avg duration\"]","direction":"ascending"}],"selectedColumnForRowThreshold":"failureRate","columnWidths":{"[\"P50 duration\"]":94.52},"columnTypeOverrides":[{"id":2929126,"fields":[],"value":"text"}],"columnOrder":["[\"Requests\"]","[\"P50 duration\"]","[\"Avg duration\"]","[\"Failures\"]","[\"Failure Rate\"]","[\"Cold starts\"]"]},"autoSelectVisualization":true,"thresholds":[{"id":1,"field":"failureRate","title":"Failure Rate","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"<","label":"","value":5},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":5},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":10}]}],"unitsOverrides":[{"identifier":"failureRate","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1762372384338}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"12":{"title":"Step 5 - Send event to SQS ","type":"data","query":"fetch spans\n| filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n| filter faas.name == \"o11y-lab-lambda-payments-executor\" and span.name == \"sqs/SendMessage\"\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n| fields \n`Count` = count, \n`Failed` = toDouble(100*countFailed)/count,\n`Avg duration` = avgDur","visualization":"table","visualizationSettings":{"autoSelectVisualization":true,"table":{"colorThresholdTarget":"background","hideColumnsForLargeResults":true,"sortBy":[{"columnId":"[\"count\"]","direction":"ascending"}],"columnWidths":{"[\"count\"]":47.95,"[\"failed\"]":59}},"unitsOverrides":[{"identifier":"failed","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025},{"identifier":"avgDur","unitCategory":"time","baseUnit":"nanosecond","displayUnit":null,"decimals":0,"suffix":"","delimiter":false,"added":1762413786398}],"thresholds":[{"id":1,"field":"failed","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":0},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":""},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":1}]}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"13":{"title":"Step 7 - Update DynamoDB","type":"data","query":"// fetch spans\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n// | filter faas.name == \"o11y-lab-lambda-payments-wallet\" and span.name == \"UpdateItem dynamodb\"\n// | fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n// | summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n// | fields count, failed = toDouble(100*countFailed)/count, avgDur\n\n\n\nfetch spans\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n| filter faas.name == $LambdaWalletName and span.name == \"UpdateItem dynamodb\"\n| filter db.collection.name == $PaymentEvent\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n| fields count, failed = toDouble(100*countFailed)/count, avgDur\n| fieldsAdd dbName = $PaymentEvent\n| append [\n  fetch spans\n  | filter faas.name == $LambdaWalletName and span.name == \"UpdateItem dynamodb\"\n  | filter db.collection.name == $Wallet\n  | fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n  | summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n  | fields count, failed = toDouble(100*countFailed)/count, avgDur\n  | fieldsAdd dbName = $Wallet\n]\n| fields DB = dbName,\n`Count` = count, \n`Failed` = failed,\n`Avg duration` = avgDur\n","visualization":"table","visualizationSettings":{"autoSelectVisualization":true,"table":{"colorThresholdTarget":"background","hideColumnsForLargeResults":true,"sortBy":[{"columnId":"[\"DB\"]","direction":"ascending"}],"columnWidths":{"[\"count\"]":64.94,"[\"failed\"]":68,"[\"avgDur\"]":68}},"unitsOverrides":[{"identifier":"failed","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025},{"identifier":"avgDur","unitCategory":"time","baseUnit":"nanosecond","displayUnit":null,"decimals":0,"suffix":"","delimiter":false,"added":1762413809269}],"thresholds":[{"id":1,"field":"failed","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":0},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":""},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":1}]}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"14":{"title":"Step 6 - Wallet","type":"data","query":"fetch spans\n// | filter subtrace.is_root_span == true\n//     and span.kind == \"consumer\"\n//     and faas.trigger == \"pubsub\"\n//     and messaging.source.name == \"o11y-lab-payment-execution-queue\"\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n| filter faas.name == $LambdaWalletName and span.name == \"handler\"\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize {\n    Requests = count(),\n    `P50 duration` = percentile(duration, 50),\n    `Avg duration` = avg(duration),\n    Failures = countIf(isFailed),\n    `Cold starts` = countIf(faas.coldstart)\n}\n| fieldsAdd `Failure Rate` = if(Requests > 0, \n    (toDouble(Failures) / toDouble(Requests)) * 100, \n    else: 0)","visualization":"table","visualizationSettings":{"table":{"colorThresholdTarget":"background","columnOrder":["[\"Requests\"]","[\"P50 duration\"]","[\"Avg duration\"]","[\"Failures\"]","[\"Failure Rate\"]","[\"Cold starts\"]"],"hideColumnsForLargeResults":false,"sortBy":[{"columnId":"[\"count\"]","direction":"ascending"}],"columnWidths":{"[\"count\"]":72.94,"[\"failed\"]":65,"[\"avgDur\"]":67}},"autoSelectVisualization":true,"thresholds":[{"id":1,"field":"failed","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":0},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":""},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":1}]}],"unitsOverrides":[{"identifier":"failed","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025},{"identifier":"avgDur","unitCategory":"time","baseUnit":"nanosecond","displayUnit":null,"decimals":0,"suffix":"","delimiter":false,"added":1762413798653}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"15":{"type":"markdown","content":"Wallet\n\n|\n\n|\n\n|\n\n|\n\n|\n\n|\n\n|\n\n|"},"22":{"title":"End to end success rate Step 1 -> Step 5","type":"data","query":"fetch spans\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n| filter faas.name == \"o11y-lab-lambda-payments-initializer\" and span.name == \"handler\"\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n| fields successStart = count - countFailed\n| append [\n  fetch spans\n  // | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId))   \n  | filter faas.name == \"o11y-lab-lambda-payments-executor\" and span.name == \"handler\"\n  | fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n  | summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n  | fields successEnd = count - countFailed\n]\n| summarize successStart = max(successStart), successEnd = max(successEnd)\n| fields successRate = toDouble(100*successEnd) / successStart","visualization":"singleValue","visualizationSettings":{"autoSelectVisualization":false,"singleValue":{"labelMode":"none","colorThresholdTarget":"background"},"thresholds":[{"id":1,"field":"successRate","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":100},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":80},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":0}]}],"unitsOverrides":[{"identifier":"successRate","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"23":{"title":"End to end success rate Step 1 -> Step 7","type":"data","query":"fetch spans\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n| filter faas.name == $LambdaInitializerName and span.name == \"handler\"\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n| fields successStart = count - countFailed\n| append [\n  fetch spans\n  // | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId))   \n  | filter faas.name == $LambdaWalletName and span.name == \"handler\"\n  | fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n  | summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n  | fields successEnd = count - countFailed\n]\n| summarize successStart = max(successStart), successEnd = max(successEnd)\n| fields successRate = toDouble(100*successEnd) / successStart","visualization":"singleValue","visualizationSettings":{"singleValue":{"labelMode":"none","colorThresholdTarget":"background"},"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"successRate","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":100},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":80},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":0}]}],"unitsOverrides":[{"identifier":"successRate","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"30":{"title":"Traffic req/min","type":"data","query":"timeseries invocations=sum(cloud.aws.lambda.Invocations.By.FunctionName),\nby: {FunctionName, aws.account.id, aws.region, dt.smartscape_source.id},\n            filter:{matchesValue(aws.account.id, $AccountId) AND \n                    matchesValue(aws.region, $Region) AND \n (matchesValue(dt.smartscape_source.id, $InstanceIdInitilizer) OR \n                      matchesValue($InstanceIdInitilizer, \"ALL\"))}\n// | fieldsAdd invocationsSum = arraySum(invocations)\n| fieldsAdd invocations, interval\n\n| append [\ntimeseries invocations=sum(cloud.aws.lambda.Invocations.By.FunctionName),\nby: {FunctionName, aws.account.id, aws.region, dt.smartscape_source.id},\n            filter:{matchesValue(aws.account.id, $AccountId) AND \n                    matchesValue(aws.region, $Region) AND \n (matchesValue(dt.smartscape_source.id, $InstanceIdExecutor) OR \n                      matchesValue($InstanceIdExecutor, \"ALL\"))}\n// | fieldsAdd invocationsSum = arraySum(invocations)\n| fieldsAdd invocations, interval\n]\n\n| append [\ntimeseries invocations=sum(cloud.aws.lambda.Invocations.By.FunctionName),\nby: {FunctionName, aws.account.id, aws.region, dt.smartscape_source.id},\n            filter:{matchesValue(aws.account.id, $AccountId) AND \n                    matchesValue(aws.region, $Region) AND \n (matchesValue(dt.smartscape_source.id, $InstanceIdWallet) OR \n                      matchesValue($InstanceIdWallet, \"ALL\"))}\n// | fieldsAdd invocationsSum = arraySum(invocations)\n| fieldsAdd invocations, interval\n]\n\n| append [\ntimeseries invocations=sum(cloud.aws.apigateway.Count.By.ApiName.Stage),\n           by: {ApiName, Stage, aws.account.id, aws.region, dt.smartscape_source.id},\n           filter:{matchesValue(aws.account.id, $AccountId) AND \n                   matchesValue(aws.region, $Region) AND\n                   (matchesValue(dt.smartscape_source.id, $ApiGatewayRestInstanceId) OR matchesValue($ApiGatewayRestInstanceId, \"ALL\"))},\n           nonempty:true\n]","visualization":"lineChart","visualizationSettings":{"chartSettings":{"leftYAxisSettings":{"scale":"log"},"gapPolicy":"connect","curve":"smooth"},"dataMapping":{"displayedFields":["ApiName","FunctionName"]},"legend":{"ratio":20},"autoSelectVisualization":false,"unitsOverrides":[{"identifier":"invocations","unitCategory":"unspecified","baseUnit":"count_per_minute","displayUnit":null,"decimals":0,"suffix":"","delimiter":true,"added":1761492354881}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"31":{"title":"Errors over timeframe","description":"Time series of invocations that result in a function error.","type":"data","query":"fetch spans\n  | filter request.is_root_span == true\n    and span.kind == \"server\"\n    and contains(server.address, $APIGatewayURL) \n  | sort start_time asc\n  | fieldsAdd icon = entityAttr(dt.entity.service, \"icon\")\n  // | fieldsAdd dt.entity.service.entity.name = entityAttr(dt.entity.service, \"entity.name\"), dt.entity.host.entity.name = entityAttr(dt.entity.host, \"entity.name\"), dt.entity.process_group.entity.name = entityAttr(dt.entity.process_group, \"entity.name\"), dt.entity.process_group_instance.entity.name = entityAttr(dt.entity.process_group_instance, \"entity.name\")\n  | filter contains(faas.name, \"initializer\")\n  | filter http.response.status_code >= 400 and http.response.status_code < 599\n| makeTimeseries errorCount = count(), by: {faas.name}\n\n| append [\ntimeseries errorCount = sum(cloud.aws.lambda.Errors.By.FunctionName),\n            filter:{matchesValue(aws.account.id, $AccountId) AND \n                    matchesValue(aws.region, $Region) AND \n                    (matchesValue(dt.smartscape_source.id, $InstanceIdExecutor) OR \n                      matchesValue($InstanceIdExecutor, \"ALL\"))},\n            by: {FunctionName, aws.account.id, aws.region, dt.smartscape_source.id}\n| sort arraySum(errorCount) desc\n| limit toLong($Limit)\n]\n\n| append [\ntimeseries errorCount = sum(cloud.aws.lambda.Errors.By.FunctionName),\n            filter:{matchesValue(aws.account.id, $AccountId) AND \n                    matchesValue(aws.region, $Region) AND \n                    (matchesValue(dt.smartscape_source.id, $InstanceIdWallet) OR \n                      matchesValue($InstanceIdWallet, \"ALL\"))},\n            by: {FunctionName, aws.account.id, aws.region, dt.smartscape_source.id}\n| sort arraySum(errorCount) desc\n| limit toLong($Limit)\n]\n\n| append [\nfetch events\n| filter event.kind == \"SDLC_EVENT\"\nand event.status == \"released\"\nand event.category == \"release\"\nand event.provider == \"Makefile\"\nand contains(event.id, \"o11y-lab\")\n| filterOut contains(artifact.id, \"psp\")\n| sort end_time desc\n\n| fields Lambda = artifact.id,\n`Release version` = artifact.version,\n`Release date` = end_time\n| dedup Lambda\n| makeTimeseries count(), time: `Release date`, by: {Lambda, `Release version`}\n]\n","visualization":"lineChart","visualizationSettings":{"chartSettings":{"leftYAxisSettings":{"label":"Count","isLabelVisible":true},"xAxisLabel":"timeframe","xAxisScaling":"analyzedTimeframe","colorPalette":"fireplace","seriesOverrides":[{"seriesId":["o11y-lab-lambda-payments-executor"],"override":{"geometry":"bar","color":{"Default":"var(--dt-colors-charts-categorical-themed-blue-steel-color-05-default, #134fc9)"}}},{"seriesId":["o11y-lab-lambda-payments-initializer"],"override":{"geometry":"bar","color":{"Default":"var(--dt-colors-charts-apdex-fair-default, #a9780f)"}}},{"seriesId":["o11y-lab-lambda-payments-wallet"],"override":{"geometry":"bar","color":{"Default":"var(--dt-colors-charts-categorical-color-15-default, #9033a3)"}}}],"fieldMapping":{"leftAxisValues":["errorCount","count()"],"timestamp":"timeframe"},"curve":"smooth","gapPolicy":"connect"},"dataMapping":{"displayedFields":["errorCount","faas.name","FunctionName","Lambda"]},"legend":{"ratio":20},"autoSelectVisualization":false,"thresholds":[]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"37":{"title":"APIGateway Latency vs Lambda duration","type":"data","query":"timeseries x=avg(cloud.aws.apigateway.Latency.By.ApiName.Stage),\n           by: {ApiName, Stage, aws.account.id, aws.region, dt.smartscape_source.id},\n           filter:{matchesValue(aws.account.id, $AccountId) AND \n                   matchesValue(aws.region, $Region) AND\n                   (matchesValue(dt.smartscape_source.id, $ApiGatewayRestInstanceId) OR matchesValue($ApiGatewayRestInstanceId, \"ALL\"))}\n| sort arrayAvg(x) desc\n| fieldsAdd label = \"API Gateway: Latency\"\n| limit toLong($Limit)\n| append [\ntimeseries x=avg(cloud.aws.apigateway.IntegrationLatency.By.ApiName.Stage),\n           by: {ApiName, Stage, aws.account.id, aws.region, dt.smartscape_source.id},\n           filter:{matchesValue(aws.account.id, $AccountId) AND \n                   matchesValue(aws.region, $Region) AND\n                   (matchesValue(dt.smartscape_source.id, $ApiGatewayRestInstanceId) OR matchesValue($ApiGatewayRestInstanceId, \"ALL\"))}\n| sort arrayAvg(x) desc\n| fieldsAdd label = \"API Gateway: Integration Latency\"\n| limit toLong($Limit)\n]\n| append [\ntimeseries x=avg(cloud.aws.lambda.Duration.By.FunctionName), \n            by: {FunctionName, aws.account.id, aws.region, dt.smartscape_source.id},\n            filter:{matchesValue(aws.account.id, $AccountId) AND \n                    matchesValue(aws.region, $Region) AND \n (matchesValue(dt.smartscape_source.id, $InstanceIdInitilizer) OR \n                      matchesValue($InstanceIdInitilizer, \"ALL\"))}\n| sort arrayAvg(x) desc\n| fieldsAdd label = \"Initializer: Duration\"\n| limit toLong($Limit)\n]\n| append [\ntimeseries x=avg(cloud.aws.lambda.Duration.By.FunctionName), \n            by: {FunctionName, aws.account.id, aws.region, dt.smartscape_source.id},\n            filter:{matchesValue(aws.account.id, $AccountId) AND \n                    matchesValue(aws.region, $Region) AND \n (matchesValue(dt.smartscape_source.id, $InstanceIdExecutor) OR \n                      matchesValue($InstanceIdExecutor, \"ALL\"))}\n| sort arrayAvg(x) desc\n| fieldsAdd label = \"Executor: Duration\"\n| limit toLong($Limit)\n]\n| append [\ntimeseries x=avg(cloud.aws.lambda.Duration.By.FunctionName), \n            by: {FunctionName, aws.account.id, aws.region, dt.smartscape_source.id},\n            filter:{matchesValue(aws.account.id, $AccountId) AND \n                    matchesValue(aws.region, $Region) AND \n (matchesValue(dt.smartscape_source.id, $InstanceIdWallet) OR \n                      matchesValue($InstanceIdWallet, \"ALL\"))}\n| sort arrayAvg(x) desc\n| fieldsAdd label = \"Wallet: Duration\"\n| limit toLong($Limit)\n]","visualization":"table","visualizationSettings":{"autoSelectVisualization":true},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"42":{"title":"Errors over releases","description":"","type":"data","query":"fetch events, from: now() - 90d\n| filter event.kind == \"SDLC_EVENT\" and contains(artifact.name, $LambdaInitializerName) \n| sort timestamp desc\n| limit 2\n| summarize {times = collectArray(timestamp), versions = collectArray(artifact.version)}, by: Lambda = artifact.name\n| fieldsAdd Recent_version_release_date = arrayFirst(times)    \n| fieldsAdd Previous_version_release_date = arrayLast(times)     \n| fieldsAdd Recent_version_version = arrayFirst(versions)  \n| fieldsAdd Previous_version_version = arrayLast(versions) \n| fieldsAdd now = now() \n| fieldsRemove times, versions \n| join [\n    fetch spans\n      | filter request.is_root_span == true \n        and span.kind == \"server\"\n        and contains(server.address, $APIGatewayURL) \n        and contains(faas.name, $LambdaInitializerName)\n        and http.response.status_code >= 500 and http.response.status_code < 600\n      | fieldsKeep faas.name, start_time \n  ],\n  kind: leftOuter, \n  on: {left[Lambda] == right[faas.name]} \n| summarize {\n    errors_recent_to_now = countIf(\n        isNotNull(right.faas.name) \n        and right.start_time >= Recent_version_release_date \n        and right.start_time <= now\n    ),\n    errors_last_to_recent = countIf(\n        isNotNull(right.faas.name) \n        and right.start_time >= Previous_version_release_date \n        and right.start_time < Recent_version_release_date\n    )\n}, by: {\n    Lambda,\n    Recent_version_version,\n    Recent_version_release_date, \n    Previous_version_version,\n    Previous_version_release_date\n}\n| fieldsAdd failureStatus = if(errors_recent_to_now > errors_last_to_recent, \"Warning - increased\", \n        else: if(errors_recent_to_now < errors_last_to_recent, \"Info - decreased\", else: \"\"))\n| fields \n    Lambda,\n    `Latest version` = Recent_version_version,\n    `Release date` = Recent_version_release_date, \n    `Errors` = errors_recent_to_now, \n    `Previous version` = Previous_version_version,\n    `Previous release date` = Previous_version_release_date,\n    `Previous version errors` = errors_last_to_recent, \n    `Error ratio` = failureStatus\n\n\n| append [\n    fetch events\n    | filter event.kind == \"SDLC_EVENT\" and contains(artifact.name, $LambdaExecutorName) \n    | sort timestamp desc\n    | limit 2\n    | summarize {times = collectArray(timestamp), versions = collectArray(artifact.version)}, by: Lambda = artifact.name\n    | fieldsAdd Recent_version_release_date = arrayFirst(times)    \n    | fieldsAdd Previous_version_release_date = arrayLast(times)     \n    | fieldsAdd Recent_version_version = arrayFirst(versions)  \n    | fieldsAdd Previous_version_version = arrayLast(versions) \n    | fieldsAdd now = now() \n    | fieldsRemove times, versions \n    | join [\n        fetch spans\n        | fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n        | filter request.is_root_span == true \n          and contains(faas.name, $LambdaExecutorName)\n          and ((http.response.status_code >= 500 and http.response.status_code < 600) or isFailed) \n        | fieldsKeep faas.name, start_time, isFailed\n      ],\n      kind: leftOuter, \n      on: {left[Lambda] == right[faas.name]} \n    | summarize {\n        errors_recent_to_now = countIf(\n            isNotNull(right.faas.name) \n            and right.start_time >= Recent_version_release_date \n            and right.start_time <= now\n        ),\n        errors_last_to_recent = countIf(\n            isNotNull(right.faas.name) \n            and right.start_time >= Previous_version_release_date \n            and right.start_time < Recent_version_release_date\n        )\n    }, by: {\n        Lambda,\n        Recent_version_version,\n        Recent_version_release_date, \n        Previous_version_version,\n        Previous_version_release_date\n    }\n    | fieldsAdd failureStatus = if(errors_recent_to_now > errors_last_to_recent, \"Warning - increased\", \n        else: if(errors_recent_to_now < errors_last_to_recent, \"Info - decreased\", else: \"\"))\n    | fields \n        Lambda,\n        `Latest version` = Recent_version_version,\n        `Release date` = Recent_version_release_date, \n        `Errors` = errors_recent_to_now, \n        `Previous version` = Previous_version_version,\n        `Previous release date` = Previous_version_release_date,\n        `Previous version errors` = errors_last_to_recent, \n        `Error ratio` = failureStatus\n]\n\n\n| append [\n    fetch events\n    | filter event.kind == \"SDLC_EVENT\" and contains(artifact.name, $LambdaWalletName) \n    | sort timestamp desc\n    | limit 2\n    | summarize {times = collectArray(timestamp), versions = collectArray(artifact.version)}, by: Lambda = artifact.name\n    | fieldsAdd Recent_version_release_date = arrayFirst(times)    \n    | fieldsAdd Previous_version_release_date = arrayLast(times)     \n    | fieldsAdd Recent_version_version = arrayFirst(versions)  \n    | fieldsAdd Previous_version_version = arrayLast(versions) \n    | fieldsAdd now = now() \n    | fieldsRemove times, versions \n    | join [\n        fetch spans\n        | fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n        | filter request.is_root_span == true \n          and contains(faas.name, $LambdaExecutorName)\n          and ((http.response.status_code >= 500 and http.response.status_code < 600) or isFailed) \n        | fieldsKeep faas.name, start_time, isFailed\n      ],\n      kind: leftOuter, \n      on: {left[Lambda] == right[faas.name]} \n    | summarize {\n        errors_recent_to_now = countIf(\n            isNotNull(right.faas.name) \n            and right.start_time >= Recent_version_release_date \n            and right.start_time <= now\n        ),\n        errors_last_to_recent = countIf(\n            isNotNull(right.faas.name) \n            and right.start_time >= Previous_version_release_date \n            and right.start_time < Recent_version_release_date\n        )\n    }, by: {\n        Lambda,\n        Recent_version_version,\n        Recent_version_release_date, \n        Previous_version_version,\n        Previous_version_release_date\n    }\n    | fieldsAdd failureStatus = if(errors_recent_to_now > errors_last_to_recent, \"Warning - increased\", \n        else: if(errors_recent_to_now < errors_last_to_recent, \"Info - decreased\", else: \"\"))\n    | fields \n        Lambda,\n        `Latest version` = Recent_version_version,\n        `Release date` = Recent_version_release_date, \n        `Errors` = errors_recent_to_now, \n        `Previous version` = Previous_version_version,\n        `Previous release date` = Previous_version_release_date,\n        `Previous version errors` = errors_last_to_recent, \n        `Error ratio` = failureStatus\n]","visualization":"table","visualizationSettings":{"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"Error ratio","title":"","isEnabled":true,"rules":[{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"=","label":"","value":"Warning - increased"}]}],"unitsOverrides":[{"identifier":"Errors","unitCategory":"unspecified","baseUnit":"none","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1762899137737}],"table":{"colorThresholdTarget":"background","hideColumnsForLargeResults":false,"selectedColumnForRowThreshold":"Error ratio","columnWidths":{"[\"Error ratio\"]":170}}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"44":{"type":"markdown","content":"# Releases"},"46":{"title":"Percentiles with cold starts","type":"data","query":"fetch spans\n| filter (request.is_root_span == true and span.kind == \"server\" and contains(server.address, $APIGatewayURL))\n    or (faas.name == $LambdaExecutorName and span.name == \"handler\")\n    or (faas.name == $LambdaWalletName and span.name == \"handler\")\n| filter faas.coldstart == true\n| summarize ColdP50 = median(duration), ColdP95 = percentile(duration, 95), ColdCount = count(), by: Lambda = faas.name\n| lookup [\n    fetch spans\n    | filter (request.is_root_span == true and span.kind == \"server\" and contains(server.address, $APIGatewayURL))\n        or (faas.name == $LambdaExecutorName and span.name == \"handler\")\n        or (faas.name == $LambdaWalletName and span.name == \"handler\")\n    | filter faas.coldstart == false\n    | summarize WarmP50 = median(duration), WarmP95 = percentile(duration, 95), WarmCount = count(), by: Lambda = faas.name\n], sourceField: Lambda, lookupField: Lambda, prefix: \"w.\"\n| fieldsAdd DeltaP50 = ColdP50 - w.WarmP50\n| fieldsAdd DeltaP95 = ColdP95 - w.WarmP95\n| fieldsRename WarmP50 = w.WarmP50, WarmP95 = w.WarmP95, WarmCount = w.WarmCount\n| fieldsKeep Lambda, ColdCount, WarmCount,\n             ColdP50, WarmP50, DeltaP50,\n             ColdP95, WarmP95, DeltaP95\n| sort DeltaP95 desc","visualization":"table","visualizationSettings":{"autoSelectVisualization":true,"table":{"hideColumnsForLargeResults":true,"sortBy":[{"columnId":"[\"faas.name\"]","direction":"ascending"}]},"unitsOverrides":[]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"48":{"title":"End to end P95 duration Step 1 -> Step 3","type":"data","query":"fetch spans\n| filter faas.name == $LambdaInitializerName and span.name == \"handler\"\n| summarize {\n    `p95` = percentile(duration, 95)\n}\n","visualization":"singleValue","visualizationSettings":{"singleValue":{"labelMode":"none","colorThresholdTarget":"background"},"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"p95","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"<","label":"","value":300000000},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":300000000},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":400000000}]}],"unitsOverrides":[{"identifier":"p95","unitCategory":"time","baseUnit":"nanosecond","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"49":{"title":"End to end success rate Step 1 -> Step 3","type":"data","query":"fetch spans\n// | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n| filter faas.name == $LambdaInitializerName and span.name == \"handler\"\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n| fields successStart = count - countFailed\n| append [\n  fetch spans\n  // | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId))   \n  | filter faas.name == $LambdaInitializerName and span.name == \"sqs/SendMessage\"\n  | fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n  | summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n  | fields successEnd = count - countFailed\n]\n| summarize successStart = max(successStart), successEnd = max(successEnd)\n| fields successRate = toDouble(100*successEnd) / successStart","visualization":"singleValue","visualizationSettings":{"singleValue":{"labelMode":"none","colorThresholdTarget":"background"},"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"successRate","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":100},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":80},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":0}]}],"unitsOverrides":[{"identifier":"successRate","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"50":{"title":"End to end P95 duration Step 1 -> Step 3","type":"data","query":"fetch spans\n| filter faas.name == $LambdaExecutorName and span.name == \"handler\"\n| summarize {\n    `p95` = percentile(duration, 95)\n}","visualization":"singleValue","visualizationSettings":{"autoSelectVisualization":false,"singleValue":{"labelMode":"none","colorThresholdTarget":"background"},"thresholds":[{"id":1,"field":"p95","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"<","label":"","value":700000000},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":700000000},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":850000000}]}],"unitsOverrides":[{"identifier":"successRate","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"51":{"title":"End to end P95 duration Step 1 -> Step 3","type":"data","query":"fetch spans\n| filter faas.name == $LambdaWalletName and span.name == \"handler\"\n| summarize {\n    `p95` = percentile(duration, 95)\n}","visualization":"singleValue","visualizationSettings":{"autoSelectVisualization":false,"singleValue":{"labelMode":"none","colorThresholdTarget":"background"},"thresholds":[{"id":1,"field":"p95","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"<","label":"","value":350000000},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":350000000},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":500000000}]}],"unitsOverrides":[{"identifier":"successRate","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"54":{"title":"Explore metrics","type":"data","subType":"dql-builder-metrics","query":"timeseries { sum(payment.psp.loss_reveniu), value.A = avg(payment.psp.loss_reveniu, scalar: true), sum(payment.psp.reveniue), value.B = avg(payment.psp.reveniue, scalar: true) }, union: TRUE, interval: 1m","visualization":"barChart","visualizationSettings":{"chartSettings":{"xAxisScaling":"auto","seriesOverrides":[{"seriesId":["sum(o11y.lambda.loss_reveniue)"],"override":{"color":{"Default":"var(--dt-colors-charts-categorical-themed-fireplace-color-01-default, #ae132d)"}}},{"seriesId":["sum(o11y.lambda.tpv)"],"override":{"color":{"Default":"var(--dt-colors-charts-categorical-color-01-default, #134fc9)"}}}]},"legend":{"ratio":16},"autoSelectVisualization":false},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"queryConfig":{"version":"19.2.2","subQueries":[{"id":"A","isEnabled":true,"datatype":"metrics","metric":{"key":"payment.psp.loss_reveniu","aggregation":"sum"},"filter":"","convertToValue":"Avg"},{"id":"B","isEnabled":true,"datatype":"metrics","metric":{"key":"payment.psp.reveniue","aggregation":"sum"},"filter":"","convertToValue":"Avg"}],"globalCommands":{"interval":"1m"}},"davis":{"enabled":false,"componentState":{"selectedAnalyzerName":"dt.statistics.ui.ForecastAnalyzer","inputData":{"dt.statistics.ui.ForecastAnalyzer":{"generalParameters":{"timeframe":{"startTime":"2025-11-23T19:02:43.895Z","endTime":"2025-11-23T20:59:55.075Z"},"resolveDimensionalQueryData":true,"logVerbosity":"INFO"},"forecastHorizon":10,"forecastOffset":1,"query":{"expression":"timeseries { sum(o11y.lambda.loss_reveniue), value.A = avg(o11y.lambda.loss_reveniue, scalar: true), sum(o11y.lambda.tpv), value.B = avg(o11y.lambda.tpv, scalar: true) }, union: TRUE, interval: 1m"}}}},"davisVisualization":{"isAvailable":true,"selectedOutputs":["1257979211"]}},"timeframe":{"tileTimeframe":{"from":"now()-30m","to":"now()"},"tileTimeframeEnabled":false}},"55":{"title":"PSP latency","type":"data","subType":"dql-builder-metrics","query":"timeseries avg(payment.psp.latency_ms), interval: 1m","visualization":"lineChart","visualizationSettings":{"chartSettings":{"xAxisScaling":"auto","curve":"smooth","gapPolicy":"connect"},"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≤","label":"","value":650},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":650},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":1000}]}],"unitsOverrides":[{"identifier":"max(payment.psp.latency_ms)","unitCategory":"time","baseUnit":"millisecond","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764182934694}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"queryConfig":{"version":"19.2.2","subQueries":[{"id":"A","isEnabled":true,"datatype":"metrics","metric":{"key":"payment.psp.latency_ms","aggregation":"avg"},"filter":""}],"globalCommands":{"interval":"1m"}},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}},"timeframe":{"tileTimeframe":{"from":"now()-30m","to":"now()"},"tileTimeframeEnabled":false}},"57":{"type":"markdown","content":"# Business"},"75":{"title":"","type":"data","query":"// Revenue Tile\nfetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.checkout.settled\"\n| summarize total_revenue = sum(toDouble(json[`amount.total`]))","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Total Revenue","recordField":"total_revenue","isIconVisible":true,"prefixIcon":"MoneyIcon","colorThresholdTarget":"background","trend":{"isVisible":true,"trendField":"total_revenue","isRelative":false}},"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"total_revenue","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":0},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":""},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":""}]}],"unitsOverrides":[{"identifier":"total_revenue","unitCategory":"currency","baseUnit":"usd","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764425007568}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"77":{"title":"","type":"data","query":"// Lost Revenue Tile\nfetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.checkout.rejected\"\n    or json[event_type] == \"payment.checkout.failed\"\n    or (json[event_type] == \"payment.psp.response\" and json[outcome] == \"FAILURE\")\n| summarize lost_revenue = sum(toDouble(json[`amount.total`]))","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Lost Revenue","isIconVisible":true,"prefixIcon":"MinusIcon","trend":{"isVisible":true,"trendField":"lost_revenue","isRelative":false}},"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"lost_revenue","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":""},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":0},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":""}]}],"unitsOverrides":[{"identifier":"lost_revenue","unitCategory":"currency","baseUnit":"usd","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764425087293}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"78":{"title":"","type":"data","query":"fetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.request.received\"\n    or json[event_type] == \"payment.checkout.settled\"\n| summarize \n    received = countIf(json[event_type] == \"payment.request.received\"),\n    settled = countIf(json[event_type] == \"payment.checkout.settled\")\n| fieldsAdd conversion_rate = toDouble(settled) / toDouble(received) * 100\n| fields conversion_rate","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Conversion Rate","isIconVisible":true,"colorThresholdTarget":"background","trend":{"isVisible":true,"trendField":"conversion_rate"}},"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"conversion_rate","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":95},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":90},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"<","label":"","value":90}]}],"unitsOverrides":[{"identifier":"conversion_rate","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":false,"added":1764422601644}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"81":{"title":"","type":"data","query":"fetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.request.received\"\n| summarize received = count()\n| fieldsAdd pct = 100.0\n| fields pct","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Received"},"autoSelectVisualization":false,"unitsOverrides":[{"identifier":"pct","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764426833414}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"82":{"title":"","type":"data","query":"fetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.request.received\"\n    or json[event_type] == \"payment.checkout.initiated\"\n| summarize \n    received = countIf(json[event_type] == \"payment.request.received\"),\n    validated = countIf(json[event_type] == \"payment.checkout.initiated\")\n| fieldsAdd pct = toDouble(validated) / toDouble(received) * 100\n| fields pct","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Validated"},"autoSelectVisualization":false,"unitsOverrides":[{"identifier":"pct","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764524163050}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"83":{"title":"","type":"data","query":"fetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.request.received\"\n    or json[event_type] == \"payment.checkout.queued\"\n| summarize \n    received = countIf(json[event_type] == \"payment.request.received\"),\n    queued = countIf(json[event_type] == \"payment.checkout.queued\")\n| fieldsAdd pct = toDouble(queued) / toDouble(received) * 100\n| fields pct","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Queued"},"autoSelectVisualization":false,"unitsOverrides":[{"identifier":"pct","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764528205542}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"84":{"title":"","type":"data","query":"fetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.request.received\"\n    or (json[event_type] == \"payment.psp.response\" and json[outcome] == \"SUCCESS\")\n| summarize \n    received = countIf(json[event_type] == \"payment.request.received\"),\n    psp_ok = countIf(json[event_type] == \"payment.psp.response\" and json[outcome] == \"SUCCESS\")\n| fieldsAdd pct = toDouble(psp_ok) / toDouble(received) * 100\n| fields pct","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Payment Completion Rate"},"autoSelectVisualization":false,"unitsOverrides":[{"identifier":"pct","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764528223222}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"86":{"title":"","type":"data","query":"fetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.request.received\"\n    or json[event_type] == \"payment.wallet.queued\"\n| summarize \n    received = countIf(json[event_type] == \"payment.request.received\"),\n    wallet = countIf(json[event_type] == \"payment.wallet.queued\")\n| fieldsAdd pct = toDouble(wallet) / toDouble(received) * 100\n| fields pct","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Wallet"},"autoSelectVisualization":false,"unitsOverrides":[{"identifier":"pct","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764528233759}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"87":{"title":"","type":"data","query":"fetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.request.received\"\n    or json[event_type] == \"payment.checkout.settled\"\n| summarize \n    received = countIf(json[event_type] == \"payment.request.received\"),\n    settled = countIf(json[event_type] == \"payment.checkout.settled\")\n| fieldsAdd pct = toDouble(settled) / toDouble(received) * 100\n| fields pct","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Settled"},"autoSelectVisualization":false,"unitsOverrides":[{"identifier":"pct","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764528246186}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"88":{"title":"","type":"data","query":"// Error Breakdown by Stage\nfetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.checkout.rejected\"\n    or json[event_type] == \"payment.checkout.failed\"\n    or (json[event_type] == \"payment.psp.response\" and json[outcome] == \"FAILURE\")\n| fieldsAdd \n    failure_stage = if(json[event_type] == \"payment.checkout.rejected\", \"1_VALIDATION\",\n        else: if(json[event_type] == \"payment.psp.response\", \"2_PSP\",\n        else: \"3_SETTLEMENT\"))\n| summarize \n    error_count = count(),\n    lost_amount = sum(toDouble(json[`amount.total`])),\n    by: { failure_stage }\n| sort failure_stage asc","visualization":"table","visualizationSettings":{"autoSelectVisualization":true,"table":{"hideColumnsForLargeResults":true,"sortBy":[{"columnId":"[\"failure_stage\"]","direction":"descending"}]}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"89":{"title":"","type":"data","query":"// Error Codes with Actionable Insights\nfetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.order.failed\"\n    or json[event_type] == \"payment.checkout.rejected\"\n    or (json[event_type] == \"payment.psp.response\" and json[outcome] == \"FAILURE\")\n| summarize \n    count = count(),\n    lost_amount = sum(toDouble(json[`amount.total`])),\n    by: { error_code = coalesce(json[`error.code`], json[`psp.response.error_code`], \"UNKNOWN\") }\n| fieldsAdd action = if(error_code == \"EXPIRED_CARD\", \"Increase card update reminders\",\n    else: if(error_code == \"INVALID_CARD\", \"Improve form validation\",\n    else: if(error_code == \"FRAUD_SUSPECTED\", \"Security review needed\",\n    else: if(error_code == \"INSUFFICIENT_FUNDS\", \"Consider retry/split payment\",\n    else: if(error_code == \"NETWORK_ERROR\", \"Monitor PSP health\",\n    else: \"Monitor\")))))\n| sort count desc\n| limit 10","visualization":"table","visualizationSettings":{"autoSelectVisualization":true,"table":{"hideColumnsForLargeResults":true}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"90":{"title":"","type":"data","query":"fetch logs\n| parse content, \"JSON:json\"\n| filter json[function_name] == \"o11y-lab-lambda-payments-wallet\"\n| filter json[event_type] == \"payment.order.settled\" \n    or json[event_type] == \"payment.order.failed\"\n| summarize \n    total_orders = count(),\n    successful = countIf(json[event_type] == \"payment.order.settled\"),\n    failed = countIf(json[event_type] == \"payment.order.failed\"),\n    total_revenue = sum(toDouble(json[`amount.total`])),\n    avg_order_value = avg(toDouble(json[`amount.total`])),\n    by: { merchant_id = json[`merchant.id`] }\n| fieldsAdd error_rate_pct = toDouble(failed) / toDouble(total_orders) * 100\n| sort error_rate_pct desc","visualization":"table","visualizationSettings":{"autoSelectVisualization":true,"table":{"hideColumnsForLargeResults":true}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"91":{"title":"","type":"data","query":"fetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.psp.response\"\n| fieldsAdd latency = toDouble(json[`psp.latency.ms`])\n| summarize \n    p50 = percentile(latency, 50),\n    p95 = percentile(latency, 95),\n    p99 = percentile(latency, 99),\n    avg_latency = avg(latency),\n    max_latency = max(latency)","visualization":"table","visualizationSettings":{"autoSelectVisualization":false,"table":{"hideColumnsForLargeResults":true}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"96":{"title":"Analyze","type":"data","query":"// fetch spans\n// // | filter matchesValue($TraceId, \"\") or (trace.id == toUid($TraceId)) \n// | filter faas.name == \"o11y-lab-lambda-payments-initializer\" and span.name == \"handler\"\n// | fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n// | summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n// | fields trace = concat(\"[📉\", countFailed, \" failed traces](/ui/apps/dynatrace.distributedtracing/explorer?filter=faas.name+%3D+o11y-lab-lambda-payments-initializer+AND+%28request.status_code+%3D+Failure+OR+http.response.status_code+>+400%29&tf=\",$dt_timeframe_from,\";\",$dt_timeframe_to,\")\")\n\nfetch spans\n| filter faas.name == \"o11y-lab-lambda-payments-initializer\" and span.name == \"handler\"\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n| fields \n    trace = concat(\"[📉 \", countFailed, \" failed traces](/ui/apps/dynatrace.distributedtracing/explorer?filter=faas.name+%3D+o11y-lab-lambda-payments-initializer+AND+%28request.status_code+%3D+Failure+OR+http.response.status_code+>+400%29&tf=\", $dt_timeframe_from, \";\", $dt_timeframe_to, \")\"),\n    service = \"[🔗 Service](/ui/apps/dynatrace.services/explorer/functions/AWS%20Lambda?perspective=performance&sort=healthIndicators%3Adescending&detailsId=SERVICE-6E4C8224575D97F0&sidebarOpen=false)\"\n\n","visualization":"table","visualizationSettings":{"autoSelectVisualization":true,"table":{"colorThresholdTarget":"background","hideColumnsForLargeResults":true,"sortBy":[{"columnId":"[\"trace\"]","direction":"ascending"}],"columnTypeOverrides":[{"id":2374609.199999988,"fields":["trace"],"value":"markdown"},{"id":98033.09999999404,"fields":["service"],"value":"markdown"},{"id":494390.59999999404,"fields":["logs"],"value":"markdown"}]},"unitsOverrides":[{"identifier":"failed","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025}],"thresholds":[{"id":1,"field":"failed","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":0},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":""},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":1}]}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"97":{"title":"Analyze","type":"data","query":"fetch spans\n| filter faas.name == \"o11y-lab-lambda-payments-executor\" and span.name == \"handler\"\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n| fields \n    trace = concat(\"[📉 \", countFailed, \" failed traces](/ui/apps/dynatrace.distributedtracing/explorer?filter=faas.name+%3D+o11y-lab-lambda-payments-executor+AND+%28request.status_code+%3D+Failure+OR+http.response.status_code+>+400%29&tf=\", $dt_timeframe_from, \";\", $dt_timeframe_to, \")\"),\n    service = \"[🔗 Service](/ui/apps/dynatrace.services/explorer/functions/AWS%20Lambda?perspective=performance&sort=healthIndicators%3Adescending&detailsId=SERVICE-0A913BDD25C33D50&sidebarOpen=false)\"","visualization":"table","visualizationSettings":{"autoSelectVisualization":true,"table":{"colorThresholdTarget":"background","columnTypeOverrides":[{"id":2374609.199999988,"fields":["trace"],"value":"markdown"},{"id":83548.40000000596,"fields":["service"],"value":"markdown"}],"hideColumnsForLargeResults":true,"sortBy":[{"columnId":"[\"trace\"]","direction":"ascending"}]},"unitsOverrides":[{"identifier":"failed","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025}],"thresholds":[{"id":1,"field":"failed","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":0},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":""},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":1}]}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"98":{"title":"Analyze","type":"data","query":"fetch spans\n| filter faas.name == \"o11y-lab-lambda-payments-wallet\" and span.name == \"handler\"\n| fieldsAdd isFailed = request.is_failed or http.response.status_code >= 400\n| summarize count = count(), countFailed = countIf(isFailed), avgDur = avg(duration)\n| fields \n    trace = concat(\"[📉 \", countFailed, \" failed traces](/ui/apps/dynatrace.distributedtracing/explorer?filter=faas.name+%3D+o11y-lab-lambda-payments-wallet+AND+%28request.status_code+%3D+Failure+OR+http.response.status_code+>+400%29&tf=\", $dt_timeframe_from, \";\", $dt_timeframe_to, \")\"),\n    service = \"[🔗 Service](/ui/apps/dynatrace.services/explorer/functions/AWS%20Lambda?perspective=performance&sort=healthIndicators%3Adescending&detailsId=SERVICE-1D1FB216F1AD443E&sidebarOpen=false)\"","visualization":"table","visualizationSettings":{"autoSelectVisualization":true,"table":{"colorThresholdTarget":"background","columnTypeOverrides":[{"id":2374609.199999988,"fields":["trace"],"value":"markdown"},{"id":105215.20000000298,"fields":["service"],"value":"markdown"}],"hideColumnsForLargeResults":true,"sortBy":[{"columnId":"[\"trace\"]","direction":"ascending"}]},"unitsOverrides":[{"identifier":"failed","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":1,"suffix":"","delimiter":false,"added":1762411034025}],"thresholds":[{"id":1,"field":"failed","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":0},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":""},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":1}]}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"99":{"title":"","type":"data","query":"fetch logs\n| parse content, \"JSON:json\"\n| filter json[event_type] == \"payment.psp.response\"\n| summarize \n    total = count(),\n    technical_errors = countIf(\n        json[outcome] == \"FAILURE\" \n        and json[psp.response.error_code] == \"PSP_SERVER_ERROR\"\n    ),\n    connection_errors = countIf(\n        json[outcome] == \"FAILURE\" \n        and json[psp.response.error_code] == \"CONNECTION_ERROR\"\n    )\n| fieldsAdd failures = toDouble(technical_errors) + toDouble(connection_errors)\n| fieldsAdd error_rate = (failures / total) * 100\n| fieldsAdd sli = 100 - ((failures / total) * 100)\n","visualization":"singleValue","visualizationSettings":{"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"error_rate","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"<","label":"","value":2},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":">","label":"","value":2},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":"","value":5}]}],"unitsOverrides":[{"identifier":"error_rate","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764425312653},{"identifier":"sli","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764530598905}],"singleValue":{"recordField":"error_rate","label":"PSP Error Rate","colorThresholdTarget":"background"}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"100":{"title":"","type":"data","query":"fetch bizevents\n| filter event.provider == \"o11y-lab-payment\"\n| filter event.type == \"payment.checkout.settled\"\n| filter payment.settlement.outcome == \"SUCCESS\"\n| summarize total_revenue = sum(payment.settlement.amount)","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Total Revenue","recordField":"total_revenue","isIconVisible":true,"prefixIcon":"MoneyIcon","colorThresholdTarget":"background","trend":{"isVisible":true,"trendField":"total_revenue","isRelative":false}},"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"total_revenue","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":0},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":""},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"≥","label":""}]}],"unitsOverrides":[{"identifier":"total_revenue","unitCategory":"currency","baseUnit":"usd","displayUnit":null,"decimals":null,"suffix":"","delimiter":false,"added":1764425007568}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"101":{"title":"","type":"data","query":"fetch bizevents\n| filter event.provider == \"o11y-lab-payment\"\n| filter event.type == \"payment.request.received\" \n      or event.type == \"payment.checkout.settled\"\n| summarize \n    received = countIf(event.type == \"payment.request.received\"),\n    settled = countIf(event.type == \"payment.checkout.settled\")\n| fieldsAdd conversion_rate = toDouble(settled) / toDouble(received) * 100\n| fields conversion_rate","visualization":"singleValue","visualizationSettings":{"singleValue":{"label":"Conversion Rate","isIconVisible":true,"colorThresholdTarget":"background","trend":{"isVisible":true,"trendField":"conversion_rate"}},"autoSelectVisualization":false,"thresholds":[{"id":1,"field":"conversion_rate","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-status-ideal-default, #2f6862)"},"comparator":"≥","label":"","value":95},{"id":1,"color":{"Default":"var(--dt-colors-charts-status-warning-default, #eea53c)"},"comparator":"≥","label":"","value":90},{"id":2,"color":{"Default":"var(--dt-colors-charts-status-critical-default, #c62239)"},"comparator":"<","label":"","value":90}]}],"unitsOverrides":[{"identifier":"conversion_rate","unitCategory":"percentage","baseUnit":"percent","displayUnit":null,"decimals":2,"suffix":"","delimiter":false,"added":1764422601644}]},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"davis":{"enabled":false,"davisVisualization":{"isAvailable":true}}},"102":{"type":"markdown","content":" "}},"layouts":{"0":{"x":0,"y":0,"w":20,"h":8},"1":{"x":0,"y":8,"w":9,"h":4},"4":{"x":0,"y":12,"w":1,"h":5},"5":{"x":1,"y":12,"w":8,"h":3},"6":{"x":9,"y":12,"w":6,"h":3},"9":{"x":15,"y":12,"w":5,"h":3},"10":{"x":0,"y":17,"w":1,"h":4},"11":{"x":1,"y":17,"w":8,"h":2},"12":{"x":9,"y":17,"w":4,"h":2},"13":{"x":9,"y":21,"w":4,"h":3},"14":{"x":1,"y":21,"w":8,"h":3},"15":{"x":0,"y":21,"w":1,"h":5},"22":{"x":1,"y":19,"w":4,"h":2},"23":{"x":1,"y":24,"w":4,"h":2},"30":{"x":0,"y":29,"w":19,"h":6},"31":{"x":0,"y":42,"w":19,"h":6},"37":{"x":0,"y":35,"w":19,"h":6},"42":{"x":0,"y":48,"w":19,"h":4},"44":{"x":0,"y":41,"w":8,"h":1},"46":{"x":0,"y":26,"w":19,"h":3},"48":{"x":5,"y":15,"w":4,"h":2},"49":{"x":1,"y":15,"w":4,"h":2},"50":{"x":5,"y":19,"w":4,"h":2},"51":{"x":5,"y":24,"w":4,"h":2},"54":{"x":0,"y":59,"w":19,"h":8},"55":{"x":0,"y":67,"w":12,"h":8},"57":{"x":0,"y":52,"w":19,"h":1},"75":{"x":0,"y":53,"w":4,"h":3},"77":{"x":4,"y":53,"w":4,"h":3},"78":{"x":8,"y":53,"w":4,"h":3},"81":{"x":0,"y":75,"w":2,"h":3},"82":{"x":2,"y":75,"w":2,"h":3},"83":{"x":4,"y":75,"w":2,"h":3},"84":{"x":6,"y":75,"w":2,"h":3},"86":{"x":8,"y":75,"w":2,"h":3},"87":{"x":10,"y":75,"w":2,"h":3},"88":{"x":12,"y":71,"w":7,"h":3},"89":{"x":12,"y":69,"w":7,"h":2},"90":{"x":0,"y":78,"w":12,"h":6},"91":{"x":12,"y":67,"w":6,"h":2},"96":{"x":9,"y":15,"w":5,"h":2},"97":{"x":9,"y":19,"w":5,"h":2},"98":{"x":9,"y":24,"w":5,"h":2},"99":{"x":12,"y":53,"w":4,"h":3},"100":{"x":0,"y":56,"w":4,"h":3},"101":{"x":8,"y":56,"w":4,"h":3},"102":{"x":9,"y":8,"w":11,"h":4}},"importedWithCode":false,"settings":{}}